<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>챗봇 - GitHub AI 코드 분석</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }
        pre {
            white-space: pre-wrap;       /* css-3 */
            white-space: -moz-pre-wrap;  /* Mozilla */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
            max-width: 100%;
            overflow-x: auto;
        }
        .msg-ai > div, .msg-user > div {
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 85% !important;
        }
        
        /* 로딩 애니메이션 스타일 - 크기 조정 */
        .loading-wrapper {
          width: 80px;
          height: 30px;
          position: relative;
          z-index: 1;
          display: inline-block;
          margin-left: 5px;
        }

        .loading-circle {
          width: 10px;
          height: 10px;
          position: absolute;
          border-radius: 50%;
          background-color: #9ca3af;
          left: 15%;
          transform-origin: 50%;
          animation: circle7124 .5s alternate infinite ease;
        }

        @keyframes circle7124 {
          0% {
            top: 30px;
            height: 3px;
            border-radius: 50px 50px 25px 25px;
            transform: scaleX(1.7);
          }

          40% {
            height: 20px;
            border-radius: 50%;
            transform: scaleX(1);
          }

          100% {
            top: 0%;
          }
        }

        .loading-circle:nth-child(2) {
          left: 45%;
          animation-delay: .2s;
        }

        .loading-circle:nth-child(3) {
          left: auto;
          right: 15%;
          animation-delay: .3s;
        }

        .loading-shadow {
          width: 10px;
          height: 2px;
          border-radius: 50%;
          background-color: rgba(0,0,0,0.5);
          position: absolute;
          top: 32px;
          transform-origin: 50%;
          z-index: -1;
          left: 15%;
          filter: blur(1px);
          animation: shadow046 .5s alternate infinite ease;
        }

        @keyframes shadow046 {
          0% {
            transform: scaleX(1.5);
          }

          40% {
            transform: scaleX(1);
            opacity: .7;
          }

          100% {
            transform: scaleX(.2);
            opacity: .4;
          }
        }

        .loading-shadow:nth-child(4) {
          left: 45%;
          animation-delay: .2s
        }

        .loading-shadow:nth-child(5) {
          left: auto;
          right: 15%;
          animation-delay: .3s;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen">
<div class="flex flex-col min-h-screen">
<!-- 상단 네비게이터 -->
<header class="bg-gray-800 p-3 flex items-center justify-between border-b border-gray-700" style="height: 100px; overflow: visible;">
  <div class="flex items-center">
    <span class="material-icons text-gray-400 mr-3">menu</span>
    <img src="/static/logo.jpg" alt="logo" class="h-36 w-36 object-contain mr-2" style="margin-top: -16px; margin-bottom: -16px;" />
    <span class="text-white font-semibold ml-3 text-lg"></span>
  </div>
  <div class="flex items-center">
    <div class="relative mr-4">
      <input class="bg-gray-700 text-gray-300 placeholder-gray-500 rounded-md py-1.5 px-3 pl-8 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="/ Type to search" style="width: 300px;" type="text"/>
      <span class="material-icons absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">search</span>
    </div>
    <button class="p-1.5 rounded-md hover:bg-gray-700 mr-2">
      <span class="material-icons text-gray-400">add</span>
    </button>
    <button class="p-1.5 rounded-md hover:bg-gray-700 mr-2">
      <span class="material-icons text-gray-400">play_arrow</span>
    </button>
    <button class="p-1.5 rounded-md hover:bg-gray-700 mr-2">
      <span class="material-icons text-gray-400">inbox</span>
    </button>
    <img alt="User avatar" class="w-8 h-8 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuC8ljbNzHJUH9ZC9WD5AFSxwpOS3_ZcKoBsLH4ppNnwv7l3PC3qZkbjVVuRXDv_LB2aLAVzFpGwFvpgU939wCp2HDeAroJdPNVKcOjo-5whV-vaimG-X5ivF_RqhmCDcnM2Bi5WXW47zGRSkP87NchAS8fDloSnEPGY0npOYffb2D5qh2IzUJZUTY6fiJmDe041cG7cQk4McvdpSkgvIh0XcwZREUgolNXnwo0yjX29hajqa2PMtaJeo8ic779fqzftRvUOJJdkRck"/>
  </div>
</header>

<!-- 메인 컨텐츠 영역 -->
<div class="flex flex-1">
  <!-- 왼쪽 사이드바 네비게이션 -->
  <div class="bg-gray-800 w-64 border-r border-gray-700 flex-shrink-0 hidden md:block">
    <div class="p-4">
      <div class="mb-6">
        <h2 class="text-white font-semibold mb-3">Top repositories</h2>
        <div class="flex justify-between items-center mb-2">
          <input type="text" placeholder="Find a repository..." class="w-full bg-gray-700 text-gray-300 rounded-md py-1 px-2 text-sm border border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
        </div>
        <div class="mt-3">
          <ul class="space-y-2">
            <li class="flex items-center">
              <span class="w-4 h-4 mr-2 rounded-full bg-green-500 flex-shrink-0"></span>
              <a href="#" class="text-gray-300 hover:text-white text-sm truncate">sample/coding_test_study</a>
            </li>
            <li class="flex items-center">
              <span class="w-4 h-4 mr-2 rounded-full bg-blue-500 flex-shrink-0"></span>
              <a href="#" class="text-gray-300 hover:text-white text-sm truncate">sample/ai_project</a>
            </li>
            <li class="flex items-center">
              <span class="w-4 h-4 mr-2 rounded-full bg-orange-500 flex-shrink-0"></span>
              <a href="#" class="text-gray-300 hover:text-white text-sm truncate">sample/code-analyzer</a>
            </li>
          </ul>
          <button class="text-xs text-gray-400 hover:text-gray-200 mt-3 flex items-center">
            <span>Show more</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- 메인 컨텐츠 -->
  <div class="flex-1">
<main class="flex-1 flex flex-col h-full">
  <!-- 상단 정보 영역 -->
  <div class="bg-gray-800 border-b border-gray-700 p-4">
    <h2 class="text-xl font-bold text-white">챗봇 - GitHub AI 코드 분석</h2>
    <div id="repo-summary" class="text-blue-300">저장소 분석이 완료되었습니다. 질문해주세요!</div>
  </div>
  
  <!-- 채팅 영역 - 전체 화면 높이를 활용 -->
  <div class="flex flex-col flex-1 h-full">
    <!-- 채팅 메시지 표시 영역 -->
    <div id="chat-box" class="flex-1 p-4 overflow-y-auto bg-gray-900" style="min-height:calc(100vh - 300px);"><!-- 채팅 메시지가 여기에 표시됩니다 --></div>
    
    <!-- 코드 미리보기 영역 -->
    <div id="code-preview" class="bg-gray-800 border-t border-gray-700 p-4 overflow-y-auto" style="max-height:30vh; display:none;"></div>
    
    <!-- 입력 폼 영역 -->
    <div class="bg-gray-800 border-t border-gray-700 p-4">
      <form id="chat-form" class="flex gap-2">
        <input type="text" class="flex-1 bg-gray-700 border border-gray-600 text-gray-200 rounded-md py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" id="user-input" placeholder="질문 또는 코드 수정 요청 입력..." autocomplete="off" required>
        <button type="submit" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-md transition-all duration-200">전송</button>
      </form>
    </div>
  </div>
</main>
<script>
const chatBox = document.getElementById('chat-box');
const codePreview = document.getElementById('code-preview');
let lastFileName = '';
let lastModifiedCode = '';
function isModifyRequest(text) {
    // 간단한 규칙: "고쳐줘", "수정", "추가", "변경" 등 포함 시 수정 요청으로 간주
    return /고쳐줘|수정|추가|변경|리팩터|refactor|fix|add|modify/i.test(text);
}
document.getElementById('chat-form').onsubmit = async function(e) {
    e.preventDefault();
    const input = document.getElementById('user-input');
    const userMsg = input.value;
    chatBox.innerHTML += `<div class="msg-user flex justify-end mb-2"><div class="bg-gray-700 text-white rounded-2xl rounded-br-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-yellow-300">나:</b> ${userMsg}</div></div>`;
    input.value = '';
    
    // AI 응답 로딩 애니메이션 추가
    const loadingId = 'loading-' + Date.now();
    chatBox.innerHTML += `
      <div id="${loadingId}" class="msg-ai flex justify-start mb-2">
        <div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow">
          <b class="text-blue-300">AI:</b>
          <div class="loading-wrapper">
            <div class="loading-circle"></div>
            <div class="loading-circle"></div>
            <div class="loading-circle"></div>
            <div class="loading-shadow"></div>
            <div class="loading-shadow"></div>
            <div class="loading-shadow"></div>
          </div>
        </div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    
    let url = '/chat';
    if (isModifyRequest(userMsg)) url = '/modify_request';
    const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: '{{ session_id }}',
            message: userMsg
        })
    });
    const data = await res.json();
    // 세션 오류 처리
    if (data.error === 'session_not_found' || data.error === 'search_error') {
        chatBox.innerHTML += `<div class="bg-red-500 text-white rounded-lg p-4 my-2 text-center"><b>AI:</b> ${marked.parse(data.answer)}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        setTimeout(() => {
            alert('세션이 만료되었거나 오류가 발생했습니다. 메인 페이지로 이동합니다.');
            window.location.href = '/';
        }, 3000);
        return;
    }
    // 일반 응답 처리
    if (data.answer) {
        // 로딩 애니메이션 제거
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // AI 응답 추가
        chatBox.innerHTML += `
          <div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${marked.parse(data.answer)} </div></div>`;
        document.querySelectorAll('#chat-box pre code').forEach((el) => {
            hljs.highlightElement(el);
            // 코드 블록 스타일 조정
            el.style.backgroundColor = '#2d3748';
            el.style.color = '#e2e8f0';
            if (!el.parentElement.querySelector('.copy-btn')) {
                const btn = document.createElement('button');
                btn.className = 'copy-btn absolute top-2 right-4 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-xs hover:bg-gray-600';
                btn.innerText = '복사';
                btn.onclick = function() {
                    navigator.clipboard.writeText(el.innerText);
                    btn.innerText = '복사됨!';
                    setTimeout(()=>{btn.innerText='복사';}, 1000);
                };
                el.parentElement.style.position = 'relative';
                el.parentElement.appendChild(btn);
            }
        });
    }
    // 코드 수정 처리
    if (data.modified_code) {
        // 로딩 애니메이션 제거
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // 채팅창 내에서 코드 미리보기 표시하도록 변경
        codePreview.style.display = 'none';
        
        lastFileName = data.file_name || '';
        lastModifiedCode = data.modified_code || '';
        const checkPushRes = await fetch('/check_push_intent', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: '{{ session_id }}',
                message: userMsg
            })
        });
        const pushData = await checkPushRes.json();
        const hasPushIntent = pushData.has_push_intent;
        const hasToken = pushData.token_exists;
        let actionButtons = '';
        if (hasPushIntent) {
            if (hasToken) {
                actionButtons = `
                    <div class="flex gap-2 mb-3">
                        <button id='apply-btn' class='bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md'>로컬에만 적용</button>
                        <button id='push-btn' class='bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md'>GitHub에 적용(push)</button>
                    </div>
                    <div id="confirmation-msg" class="bg-blue-100 text-blue-900 rounded-lg p-4 my-2" style="display:none;">
                        <p class="font-bold mb-2">GitHub 저장소에 변경사항을 적용하시겠습니까?</p>
                        <p>브랜치: <code>test</code> | 파일: <code>${lastFileName}</code></p>
                        <div class="flex gap-2 mt-2">
                            <button id="confirm-push" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">적용</button>
                            <button id="cancel-push" class="bg-gray-500 hover:bg-gray-400 text-white font-semibold py-2 px-4 rounded-md">취소</button>
                        </div>
                    </div>`;
            } else {
                actionButtons = `
                    <div class="flex gap-2 mb-3">
                        <button id='apply-btn' class='bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md'>로컬에만 적용</button>
                    </div>
                    <div class="bg-yellow-100 text-yellow-900 rounded-lg p-4 my-2">
                        <strong>GitHub 반영 기능은 토큰 입력 시에만 가능합니다.</strong><br>
                        시작 화면에서 GitHub Personal Access Token을 입력해주세요.
                    </div>`;
            }
        } else {
            actionButtons = `
                <div class="flex gap-2 mb-3">
                    <button id='apply-btn' class='bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md'>적용</button>
                </div>`;
        }
        // 코드 미리보기 내용을 채팅창에 추가
        chatBox.innerHTML += `
          <div class="msg-ai flex justify-start mb-2">
            <div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[90%] font-medium shadow" style="overflow-wrap: break-word; word-break: break-word;">
              <b class="text-blue-300">AI:</b> 아래와 같이 코드를 수정했습니다:
              <div class="mb-2 mt-3 text-gray-300"><b>파일명:</b> ${lastFileName}</div>
              <pre class="relative bg-gray-800 p-4 rounded-md overflow-x-auto"><code class="language-python">${lastModifiedCode}</code></pre>
              ${actionButtons}
            </div>
          </div>`;
        document.querySelectorAll('#code-preview pre code').forEach((el) => {
            hljs.highlightElement(el);
            // 코드 블록 스타일 조정
            el.style.backgroundColor = '#2d3748';
            el.style.color = '#e2e8f0';
            if (!el.parentElement.querySelector('.copy-btn')) {
                const btn = document.createElement('button');
                btn.className = 'copy-btn absolute top-2 right-4 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-xs hover:bg-gray-600';
                btn.innerText = '복사';
                btn.onclick = function() {
                    navigator.clipboard.writeText(el.innerText);
                    btn.innerText = '복사됨!';
                    setTimeout(()=>{btn.innerText='복사';}, 1000);
                };
                el.parentElement.style.position = 'relative';
                el.parentElement.appendChild(btn);
            }
        });
        
        // 버튼 이벤트 리스너 추가
        chatBox.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'close-preview-btn') {
                // 미리보기를 닫는 기능은 더 이상 필요하지 않지만, 버튼이 있을 경우 오류 방지
                codePreview.style.display = 'none';
            }
        });
        
        // GitHub 푸시 버튼 기능 구현
        // GitHub 푸시 버튼 기능 구현 - 이벤트 위임 사용하여 동적 생성된 버튼에 이벤트 적용
        chatBox.addEventListener('click', function(e) {
            // 푸시 버튼 클릭 처리
            if (e.target && e.target.id === 'push-btn') {
                const confirmMsg = document.getElementById('confirmation-msg');
                if (confirmMsg) confirmMsg.style.display = 'block';
            }
            
            // 확인 버튼 처리 - 이벤트 위임 사용
            // 확인 버튼 클릭 처리
            if (e.target && e.target.id === 'confirm-push') {
                // 추가 로딩 애니메이션 제거 (로딩 ID가 없을 수 있어서 모든 로딩 애니메이션 제거)
                document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                
                (async function() {
                    try {
                        const pushBtn = document.getElementById('push-btn');
                        if (pushBtn) {
                            pushBtn.disabled = true;
                            pushBtn.innerText = '처리 중...';
                        }
                        
                        const pushRes = await fetch('/push_to_github', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                session_id: '{{ session_id }}',
                                file_name: lastFileName,
                                modified_code: lastModifiedCode
                            })
                        });
                        
                        const result = await pushRes.json();
                        
                        if (result.success) {
                            chatBox.innerHTML += `
                              <div class="msg-system flex justify-center my-3">
                                <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 text-sm font-medium">
                                  <i class="material-icons align-middle text-sm mr-1">check_circle</i>
                                  GitHub에 성공적으로 코드가 적용되었습니다.
                                </div>
                              </div>`;
                        } else {
                            chatBox.innerHTML += `
                              <div class="msg-system flex justify-center my-3">
                                <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                                  <i class="material-icons align-middle text-sm mr-1">error</i>
                                  GitHub 적용 실패: ${result.error || '알 수 없는 오류'}
                                </div>
                              </div>`;
                        }
                    } catch (error) {
                        console.error('GitHub 푸시 오류:', error);
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">error</i>
                              GitHub 적용 중 오류가 발생했습니다.
                            </div>
                          </div>`;
                    } finally {
                        const confirmMsg = document.getElementById('confirmation-msg');
                        if (confirmMsg) confirmMsg.style.display = 'none';
                        
                        const pushBtn = document.getElementById('push-btn');
                        if (pushBtn) {
                            pushBtn.disabled = false;
                            pushBtn.innerText = 'GitHub에 적용(push)';
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                })();
            }
            
            // 취소 버튼 처리
            if (e.target && e.target.id === 'cancel-push') {
                const confirmMsg = document.getElementById('confirmation-msg');
                if (confirmMsg) confirmMsg.style.display = 'none';
            }
        });
        
        // 로컬 적용 버튼 기능 구현 - 이벤트 위임 사용
        chatBox.addEventListener('click', async function(e) {
            // 로컬 적용 버튼 클릭 처리
            if (e.target && e.target.id === 'apply-btn') {
                // 추가 로딩 애니메이션 제거 (로딩 ID가 없을 수 있어서 모든 로딩 애니메이션 제거)
                document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                try {
                    const applyBtn = document.getElementById('apply-btn');
                    if (applyBtn) {
                        applyBtn.disabled = true;
                        applyBtn.innerText = '적용 중...';
                    }
                    
                    const applyRes = await fetch('/apply_local', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: '{{ session_id }}',
                            file_name: lastFileName,
                            modified_code: lastModifiedCode
                        })
                    });
                    
                    const result = await applyRes.json();
                    
                    if (result.success) {
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">check_circle</i>
                              로컬에 성공적으로 코드가 적용되었습니다.
                            </div>
                          </div>`;
                    } else {
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">error</i>
                              로컬 적용 실패: ${result.error || '알 수 없는 오류'}
                            </div>
                          </div>`;
                    }
                } catch (error) {
                    console.error('로컬 적용 오류:', error);
                    chatBox.innerHTML += `
                      <div class="msg-system flex justify-center my-3">
                        <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                          <i class="material-icons align-middle text-sm mr-1">error</i>
                          로컬 적용 중 오류가 발생했습니다.
                        </div>
                      </div>`;
                } finally {
                    const applyBtn = document.getElementById('apply-btn');
                    if (applyBtn) {
                        applyBtn.disabled = false;
                        applyBtn.innerText = '로컬에만 적용';
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        });
        }
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>
  </div>
</div>
</div>
</body>
</html>