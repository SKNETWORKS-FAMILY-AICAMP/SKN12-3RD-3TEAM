<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>챗봇 - GitHub AI 코드 분석</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            background: #f8fafc;
        }
        #chat-box {
            position: relative;
            background: #f4f6fb;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        #chat-box pre {
            background: #6f95d5 !important;
            color: #f8f8f2 !important;
            border-radius: 10px;
            padding: 1.1em 1.3em;
            overflow-x: auto;
            font-size: 1.05em;
            margin-bottom: 0.7em;
            margin-top: 0.5em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .msg-user {
            display: flex; justify-content: flex-end; margin-bottom: 10px;
        }
        .msg-user .bubble {
            background: #e0f2fe; color: #1e293b; border-radius: 18px 18px 0 18px;
            padding: 12px 18px; max-width: 70%;
            font-weight: 500;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .msg-ai {
            display: flex; justify-content: flex-start; margin-bottom: 10px;
        }
        .msg-ai .bubble {
            background: #f4f6fb; color: #222; border-radius: 18px 18px 18px 0;
            padding: 12px 18px; max-width: 70%;
            border: 1px solid #e5e7eb;
            font-weight: 500;
            box-shadow: 0 1px 4px rgba(114, 142, 220, 0.04);
        }
        .msg-ai .bubble b { color: #2563eb; }
        .copy-btn {
            position: absolute; top: 8px; right: 16px; background: #fff; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; padding: 2px 8px; cursor: pointer; z-index: 2;
        }
        #chat-box pre { position: relative; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="container py-5">
    <h2 class="mb-4">챗봇 - GitHub AI 코드 분석</h2>
    <div id="repo-summary" class="mb-3">저장소 분석이 완료되었습니다. 질문해주세요!</div>
    <div id="chat-box" class="border rounded p-3 mb-3" style="height:500px; overflow-y:auto; background:#f8f9fa;"></div>
    <form id="chat-form" class="d-flex">
        <input type="text" class="form-control me-2" id="user-input" placeholder="질문 또는 코드 수정 요청 입력..." autocomplete="off" required>
        <button type="submit" class="btn btn-primary">전송</button>
    </form>
    <div id="code-preview" class="mt-4"></div>
    <script>
        const chatBox = document.getElementById('chat-box');
        const codePreview = document.getElementById('code-preview');
        let lastFileName = '';
        let lastModifiedCode = '';
        function isModifyRequest(text) {
            // 간단한 규칙: "고쳐줘", "수정", "추가", "변경" 등 포함 시 수정 요청으로 간주
            return /고쳐줘|수정|추가|변경|리팩터|refactor|fix|add|modify/i.test(text);
        }
        document.getElementById('chat-form').onsubmit = async function(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const userMsg = input.value;
            chatBox.innerHTML += `<div class="msg-user"><div class="bubble"><b>나:</b> ${userMsg}</div></div>`;
            input.value = '';
            let url = '/chat';
            if (isModifyRequest(userMsg)) url = '/modify_request';
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: '{{ session_id }}',
                    message: userMsg
                })
            });
            const data = await res.json();
            
            // 세션 오류 처리
            if (data.error === 'session_not_found' || data.error === 'search_error') {
                chatBox.innerHTML += `<div class="alert alert-danger"><b>AI:</b> ${marked.parse(data.answer)}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
                
                // 3초 후 메인 페이지로 이동
                setTimeout(() => {
                    alert('세션이 만료되었거나 오류가 발생했습니다. 메인 페이지로 이동합니다.');
                    window.location.href = '/';
                }, 3000);
                return;
            }
            
            // 일반 응답 처리
            if (data.answer) {
                chatBox.innerHTML += `
                  <div class="msg-ai"><div class="bubble"> <b>AI:</b> ${marked.parse(data.answer)} </div></div>`;
                // 코드블록 하이라이팅 적용
                document.querySelectorAll('#chat-box pre code').forEach((el) => {
                    hljs.highlightElement(el);
                    // 복사 버튼 추가
                    if (!el.parentElement.querySelector('.copy-btn')) {
                        const btn = document.createElement('button');
                        btn.className = 'copy-btn';
                        btn.innerText = '복사';
                        btn.onclick = function() {
                            navigator.clipboard.writeText(el.innerText);
                            btn.innerText = '복사됨!';
                            setTimeout(()=>{btn.innerText='복사';}, 1000);
                        };
                        el.parentElement.style.position = 'relative';
                        el.parentElement.appendChild(btn);
                    }
                });
            }
            
            // 코드 수정 처리
            if (data.modified_code) {
                lastFileName = data.file_name || '';
                lastModifiedCode = data.modified_code || '';
                codePreview.innerHTML = `<h5>수정된 코드 미리보기</h5><div><b>파일명:</b> ${lastFileName}</div><pre><code class="language-python">${lastModifiedCode}</code></pre><button id='apply-btn' class='btn btn-success'>적용</button>`;
                document.querySelectorAll('#code-preview pre code').forEach((el) => {
                    hljs.highlightElement(el);
                    // 복사 버튼 추가
                    if (!el.parentElement.querySelector('.copy-btn')) {
                        const btn = document.createElement('button');
                        btn.className = 'copy-btn';
                        btn.innerText = '복사';
                        btn.onclick = function() {
                            navigator.clipboard.writeText(el.innerText);
                            btn.innerText = '복사됨!';
                            setTimeout(()=>{btn.innerText='복사';}, 1000);
                        };
                        el.parentElement.style.position = 'relative';
                        el.parentElement.appendChild(btn);
                    }
                });
                document.getElementById('apply-btn').onclick = async function() {
                    const applyRes = await fetch('/apply_changes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: '{{ session_id }}',
                            file_name: lastFileName,
                            new_content: lastModifiedCode
                        })
                    });
                    const applyData = await applyRes.json();
                    
                    if (applyData.error) {
                        codePreview.innerHTML += `<div class='mt-2 alert alert-danger'>${applyData.error}</div>`;
                    } else {
                        codePreview.innerHTML += `<div class='mt-2 text-success'>${applyData.result}</div>`;
                    }
                }
            } else {
                codePreview.innerHTML = '';
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html> 